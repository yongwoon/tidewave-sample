<!DOCTYPE html>
<html>
  <head>
    <title>ISO9001記事スクレイピングサービス</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    <style>
      body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        margin: 0; 
        padding: 20px; 
        background-color: #f5f5f5; 
      }
      .container { 
        max-width: 1200px; 
        margin: 0 auto; 
        background: white; 
        padding: 30px; 
        border-radius: 8px; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
      }
      h1 { 
        color: #333; 
        text-align: center; 
        margin-bottom: 30px; 
        font-size: 2.2em;
      }
      .url-info { 
        background: #e8f4fd; 
        padding: 15px; 
        border-left: 4px solid #0066cc; 
        margin-bottom: 30px; 
        border-radius: 4px;
      }
      .url-info strong { 
        color: #0066cc; 
      }
      .controls { 
        text-align: center; 
        margin: 30px 0; 
      }
      .btn { 
        display: inline-block; 
        padding: 12px 24px; 
        margin: 0 10px; 
        text-decoration: none; 
        border: none; 
        border-radius: 4px; 
        cursor: pointer; 
        font-size: 16px; 
        transition: all 0.3s ease;
      }
      .btn-primary { 
        background: #007bff; 
        color: white; 
      }
      .btn-primary:hover { 
        background: #0056b3; 
      }
      .btn-success { 
        background: #28a745; 
        color: white; 
      }
      .btn-success:hover { 
        background: #1e7e34; 
      }
      .btn-danger { 
        background: #dc3545; 
        color: white; 
      }
      .btn-danger:hover { 
        background: #c82333; 
      }
      .btn:disabled { 
        opacity: 0.6; 
        cursor: not-allowed; 
      }
      .alert { 
        padding: 12px 20px; 
        margin: 20px 0; 
        border-radius: 4px; 
        font-weight: 500;
      }
      .alert-success { 
        background: #d4edda; 
        color: #155724; 
        border: 1px solid #c3e6cb; 
      }
      .alert-danger { 
        background: #f8d7da; 
        color: #721c24; 
        border: 1px solid #f5c6cb; 
      }
      .stats { 
        text-align: center; 
        margin: 20px 0; 
        font-size: 18px; 
        font-weight: 500; 
        color: #666;
      }
      table { 
        width: 100%; 
        border-collapse: collapse; 
        margin: 20px 0; 
        background: white;
      }
      th, td { 
        padding: 12px; 
        text-align: left; 
        border-bottom: 1px solid #ddd; 
        vertical-align: top;
      }
      th { 
        background: #f8f9fa; 
        font-weight: 600; 
        color: #495057;
      }
      tr:hover { 
        background: #f8f9fa; 
      }
      .title-cell { 
        max-width: 400px; 
        word-wrap: break-word; 
        line-height: 1.4;
      }
      .link-cell { 
        max-width: 300px; 
        word-wrap: break-word; 
      }
      .link-cell a { 
        color: #007bff; 
        text-decoration: none; 
      }
      .link-cell a:hover { 
        text-decoration: underline; 
      }
      .date-cell { 
        white-space: nowrap; 
        min-width: 100px;
      }
      .no-data { 
        text-align: center; 
        padding: 40px; 
        color: #666; 
        font-style: italic;
      }
      .loading { 
        text-align: center; 
        padding: 20px; 
        color: #666;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>ISO9001記事スクレイピングサービス</h1>
      
      <div class="url-info">
        <strong>対象URL:</strong> https://activation-service.jp/iso/column/type-9001/type-9001-beginner?type=category
        <br>
        <strong>対象コンテンツ:</strong> ISO9001初心者コンテンツ（新着順）
      </div>

      <% if flash[:notice] %>
        <div class="alert alert-success">
          <%= flash[:notice] %>
        </div>
      <% end %>

      <% if flash[:alert] %>
        <div class="alert alert-danger">
          <%= flash[:alert] %>
        </div>
      <% end %>

      <div class="controls">
        <%= link_to "記事をスクレイピング", scraper_scrape_path, 
            method: :get, 
            class: "btn btn-primary",
            confirm: "スクレイピングを開始しますか？（数分かかる場合があります）" %>
        
        <% if @articles.present? %>
          <%= link_to "CSVダウンロード", scraper_download_csv_path(format: :csv), 
              class: "btn btn-success" %>
          <%= link_to "PDFダウンロード", scraper_generate_pdf_path, 
              class: "btn btn-danger",
              confirm: "全記事をPDF化してZIPファイルとしてダウンロードします。時間がかかる場合があります。続行しますか？" %>
        <% else %>
          <button class="btn btn-success" disabled>CSVダウンロード（データなし）</button>
          <button class="btn btn-danger" disabled>PDFダウンロード（データなし）</button>
        <% end %>
      </div>

      <% if @articles.present? %>
        <div class="stats">
          取得記事数: <strong><%= @articles.length %>件</strong>
        </div>

        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th style="width: 50px;">#</th>
                <th style="width: 40%;">タイトル</th>
                <th style="width: 40%;">リンク</th>
                <th style="width: 20%;">日付</th>
              </tr>
            </thead>
            <tbody>
              <% @articles.each_with_index do |article, index| %>
                <tr>
                  <td><%= index + 1 %></td>
                  <td class="title-cell">
                    <strong><%= article.title %></strong>
                  </td>
                  <td class="link-cell">
                    <%= link_to article.link, article.link, 
                        target: "_blank", 
                        title: article.link %>
                  </td>
                  <td class="date-cell">
                    <%= article.date || "日付不明" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="no-data">
          まだ記事データが取得されていません。<br>
          「記事をスクレイピング」ボタンをクリックしてデータを取得してください。
        </div>
      <% end %>
    </div>

    <script>
      // スクレイピング中のローディング表示
      document.addEventListener('DOMContentLoaded', function() {
        const scrapeButton = document.querySelector('a[href*="scrape"]');
        if (scrapeButton) {
          scrapeButton.addEventListener('click', function(e) {
            if (confirm(this.getAttribute('data-confirm'))) {
              this.textContent = 'スクレイピング中...';
              this.style.opacity = '0.6';
              this.style.pointerEvents = 'none';
            }
          });
        }
      });
    </script>
  </body>
</html>